//---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop

#include "Admin.h"
#include "eMenuPCH1.h"
#include "DataModule.h"
#include "MainForm.h"
#include "Authorization.h"
#include "EditCategory.h"
#include "EditDiscount.h"
#include "EditFood.h"
#include "EditPersonal.h"
#include "EditIngredient.h"
#include "EditTabel.h"
#include "EditOrderMenu.h"
//---------------------------------------------------------------------------
#pragma package(smart_init)
#pragma resource "*.dfm"
TFAdmin *FAdmin;
//---------------------------------------------------------------------------
__fastcall TFAdmin::TFAdmin(TComponent* Owner)
	: TForm(Owner)
{
   	PanelPersonal->Align = alClient;
	PanelFood->Align = alClient;
	PanelCategory->Align = alClient;
	PanelDiscount->Align = alClient;
	PanelOrderMenu->Align = alClient;
	LookPanel->Align = alClient;
	PanelTable->Align = alClient;
    PanelReport->Align = alClient;
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::buttonViewPersonalClick(TObject *Sender)
{
      this->HidePanel(Sender);
	  PanelPersonal->Show();
}
//---------------------------------------------------------------------------




void __fastcall TFAdmin::buttonAddPersonalClick(TObject *Sender)
{
    FEditPersonal->Show();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::buttonAddCategoryClick(TObject *Sender)
{
	FEditCategory->Show();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::Button8Click(TObject *Sender)
{
	FEditFood->Show();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::buttonViewCategoryClick(TObject *Sender)
{
	  this->HidePanel(Sender);
	  PanelCategory->Show();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::buttonViewFoodClick(TObject *Sender)
{
	  this->HidePanel(Sender);
	  PanelFood->Show();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::buttonViewOrderMenuClick(TObject *Sender)
{
	  this->HidePanel(Sender);
	  PanelOrderMenu->Show();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::buttonViewDiscountClick(TObject *Sender)
{
	this->HidePanel(Sender);
	PanelDiscount->Show();
}
//---------------------------------------------------------------------------

void TFAdmin::HidePanel(TObject *Sender){
    PanelDiscount->Hide();
	PanelPersonal->Hide();
	PanelFood->Hide();
	PanelCategory->Hide();
	PanelOrderMenu->Hide();
	LookPanel->Hide();
	PanelTable->Hide();
    PanelReport->Hide();
}

//---------------------------------------------------------------------------



void __fastcall TFAdmin::DeleteCategoyClick(TObject *Sender)
{
	try {
		if (IDYES == MessageBox(NULL, L"Ви впевнені, що хочете видалити ?", L"Підвердження!",  MB_YESNO |MB_ICONQUESTION))
		{
		TCategory category;
		category.setId_category(DM->ATCategory->FieldByName("id_category")->AsInteger);
		category.DeleteDBCategory();
		DM->OpenDB();
		}
	}
	catch(...){
		MessageBox(NULL, L"Дані, пов'язанні з даною категоріює. Не можливо видалити!", L"Відмова!",  MB_OK |MB_ICONWARNING);
	}
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::AddCategoryClick(TObject *Sender)
{
    FEditCategory->Show();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::EditCategoryClick(TObject *Sender)
{
	FEditCategory->Show();
	FEditCategory->EditID->Text = DM->ATCategory->FieldByName("id_category")->AsAnsiString;
	FEditCategory->edit_name_category->Text = DM->ATCategory->FieldByName("name_category")->AsAnsiString;
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::EditSearchCategoryChange(TObject *Sender)
{
   	AnsiString tmp = EditSearchCategory->Text;
	DM->ATCategory->Filtered = false;
	if (tmp.Length()!=0){
		DM->ATCategory->Filter = "name_category like '%"+tmp+"%'";
        DM->ATCategory->Filtered = true;
	}

}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::Button2Click(TObject *Sender)
{
	FEditDiscount->Show();
	FEditDiscount->add = true;
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::AddDiscountClick(TObject *Sender)
{
	FEditDiscount->Show();
	FEditDiscount->add = true;
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::EditDiscountClick(TObject *Sender)
{
	FEditDiscount->Show();
	FEditDiscount->add = false;
	FEditDiscount->edit_id->Text = DM->ATDiscountid_discount->Value;
	FEditDiscount->edit_pib_client->Text = DM->ATDiscountpib_client->Value;
	FEditDiscount->edit_discount->Text = DM->ATDiscountdiscount->Value;
	FEditDiscount->edit_telefon->Text = DM->ATDiscounttelefon->Value;
	FEditDiscount->edit_adress->Text = DM->ATDiscountadress->Value;
	FEditDiscount->date_birthday->Date = DM->ATDiscount->FieldByName("birthday")->AsDateTime;
	FEditDiscount->Button1->Hide();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::DeleteDiscountClick(TObject *Sender)
{
	try {
		if (IDYES == MessageBox(NULL, L"Ви впевнені, що хочете видалити ?", L"Підвердження!",  MB_YESNO |MB_ICONQUESTION))
		{
			TDiscount discount;
			discount.setId_discount(DM->ATDiscountid_discount->Value);
			discount.DeleteDBDiscount();
			DM->OpenDB();
		}
	}
	catch(...){
		MessageBox(NULL, L"Дані, пов'язанні з даною категоріює. Не можливо видалити!", L"Відмова!",  MB_OK |MB_ICONWARNING);
	}
}
//---------------------------------------------------------------------------







void __fastcall TFAdmin::EditPersonalClick(TObject *Sender)
{
	FEditPersonal->Show();
	FEditPersonal->add = false;
	FEditPersonal->ButtonRelease->Show();
	FEditPersonal->edit_date_release->Show();
	FEditPersonal->Label3->Show();
	FEditPersonal->EditID->Text = DM->ATPersonal->FieldByName("id_personal")->AsAnsiString;
	FEditPersonal->edit_login->Text = DM->ATPersonal->FieldByName("logins")->AsAnsiString;
	FEditPersonal->edit_password->Text = DM->ATPersonal->FieldByName("passwords")->AsAnsiString;
	FEditPersonal->edit_pib_personal->Text = DM->ATPersonal->FieldByName("pib_personal")->AsAnsiString;
	FEditPersonal->edit_telefon->Text = DM->ATPersonal->FieldByName("telefon")->AsAnsiString;
	FEditPersonal->PersonalAccess->Checked = DM->ATPersonal->FieldByName("access")->AsBoolean;
	FEditPersonal->PersonalActivity->Checked = DM->ATPersonal->FieldByName("activity")->AsBoolean;
	FEditPersonal->date_work->Date = DM->ATPersonal->FieldByName("data_of_work")->AsDateTime;
	FEditPersonal->date_birthday->Date = DM->ATPersonal->FieldByName("birthday")->AsDateTime;
	FEditPersonal->edit_date_release->Text = DM->ATPersonal->FieldByName("release_date")->AsAnsiString;
	FEditPersonal->edit_adress->Text = DM->ATPersonal->FieldByName("adress")->AsAnsiString;
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::AddPersonaClick(TObject *Sender)
{
	FEditPersonal->Show();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::EditSearchPersonalChange(TObject *Sender)
{
	AnsiString tmp = EditSearchPersonal->Text;
	DM->ATPersonal->Filtered = false;
	if (tmp.Length()!=0){
		DM->ATPersonal->Filter = "logins like '%"+tmp+"%' or pib_personal like '%"+tmp+"%'";
		DM->ATPersonal->Filtered = true;
	}
}
//--------------------------------------1-------------------------------------

void __fastcall TFAdmin::DeletePersonalClick(TObject *Sender)
{
   try {
		if (IDYES == MessageBox(NULL, L"Ви впевнені, що хочете видалити ?", L"Підвердження!",  MB_YESNO |MB_ICONQUESTION))
		{
			if(DM->ATPersonal->FieldByName("id_personal")->AsInteger != 1){
				TPersonal personal;
				personal.setId_personal(DM->ATPersonal->FieldByName("id_personal")->AsInteger);
				personal.DeleteDBPersonal();
				DM->OpenDB();
			} else MessageBox(NULL, L"Видалення стандартного адміністратора заборонено!", L"Відмова!",  MB_OK |MB_ICONERROR);
		}
	}
	catch(...){
		MessageBox(NULL, L"Дані, пов'язанні з даною категоріює. Не можливо видалити!", L"Відмова!",  MB_OK |MB_ICONWARNING);
	}
}
//---------------------------------------------------------------------------



void __fastcall TFAdmin::N4Click(TObject *Sender)
{
    FAuth->NotUserStatus(Sender);
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::N5Click(TObject *Sender)
{
    FMainForm->Close();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::N2Click(TObject *Sender)
{
    DM->OpenDB();
}
//---------------------------------------------------------------------------


void __fastcall TFAdmin::AddFoodClick(TObject *Sender)
{
	FEditFood->Show();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::EditFoodClick(TObject *Sender)
{
	 FEditFood->Show();
	 FEditFood->add = false;
	 FEditFood->CB_id_category->Text = DM->ATFood->FieldByName("kod_category")->AsString;
	 FEditFood->CB_name_category->Text = DM->ATFood->FieldByName("name_category")->AsString;
	 FEditFood->CB_unit->Text =  DM->ATFood->FieldByName("unit_food")->AsString;
	 FEditFood->EditID->Text = DM->ATFood->FieldByName("id_food")->AsString;
	 FEditFood->Edit_cost_price->Text =  DM->ATFood->FieldByName("cost_price_food")->AsString;
	 FEditFood->Edit_mark_up->Text =  DM->ATFood->FieldByName("mark_up")->AsString;
	 FEditFood->Edit_price->Text =  DM->ATFood->FieldByName("price_food")->AsString;
	 FEditFood->Edit_name_food->Text =  DM->ATFood->FieldByName("name_food")->AsString;
	 FEditFood->Edit_weight->Text =  DM->ATFood->FieldByName("weight_food")->AsString;
     FEditFood->CBvisible->Checked = DM->ATFood->FieldByName("visible")->AsBoolean;
	 FEditFood->Image1->Picture->Assign(DM->ATFood->FieldByName("picture"));
}
//---------------------------------------------------------------------------


void __fastcall TFAdmin::DeleteFoodClick(TObject *Sender)
{
   try {
		if (IDYES == MessageBox(NULL, L"Ви впевнені, що хочете видалити ?", L"Підвердження!",  MB_YESNO |MB_ICONQUESTION))
		{
				TFood food;
				food.setIdFood(DM->ATFoodid_food->Value);
				food.DeleteDBFood();
				DM->OpenDB();
		}
	}
	catch(...){
		MessageBox(NULL, L"Дані, пов'язанні з даною інформацією. Не можливо видалити!", L"Відмова!",  MB_OK |MB_ICONWARNING);
	}
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::EditSearchFoodChange(TObject *Sender)
{
	AnsiString tmp = EditSearchFood->Text;
	DM->ATFood->Filtered = false;
	if (tmp.Length()!=0){
		DM->ATFood->Filter = "name_food like '%"+tmp+"%' or name_category like '%"+tmp+"%'";
		DM->ATFood->Filtered = true;
	}
}
//---------------------------------------------------------------------------



void __fastcall TFAdmin::ButtonViewTableClick(TObject *Sender)
{
	this->HidePanel(Sender);
	PanelTable->Show();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::EditSearchTableChange(TObject *Sender)
{
	AnsiString tmp = EditSearchTable->Text;
	DM->ATListTable->Filtered = false;
	if (tmp.Length()!=0){
		DM->ATListTable->Filter = "name_table like '%"+tmp+"%'";
        DM->ATListTable->Filtered = true;
	}
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::AddTableClick(TObject *Sender)
{
    FEditTable->Show();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::DeleteTableClick(TObject *Sender)
{
	  try {
		if (IDYES == MessageBox(NULL, L"Ви впевнені, що хочете видалити ?", L"Підвердження!",  MB_YESNO |MB_ICONQUESTION))
		{
				TListTable table;
				table.setId_table(DM->ATListTable->FieldByName("id_table")->AsInteger);
				table.DeleteDBListTable();
				DM->OpenDB();
		}
	}
	catch(...){
		MessageBox(NULL, L"Дані, пов'язанні з даною інформацією. Не можливо видалити!", L"Відмова!",  MB_OK |MB_ICONWARNING);
	}
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::ButtonAddListTableClick(TObject *Sender)
{
    FEditTable->Show();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::InvOcupTableClick(TObject *Sender)
{
     TListTable table;
	 table.setId_table(DM->ATListTable->FieldByName("id_table")->AsInteger);
	 table.UpdateInverseOccupation();
     DM->RefreshADO(DM->ATListTable);
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::N7Click(TObject *Sender)
{
    FEditOrderMenu->Show();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::AddOrderMenuClick(TObject *Sender)
{
    FEditOrderMenu->Show();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::DeleteOrderMenuClick(TObject *Sender)
{
	  try {
		if (IDYES == MessageBox(NULL, L"Ви впевнені, що хочете видалити ?", L"Підвердження!",  MB_YESNO |MB_ICONQUESTION))
		{
				TOrderMenu order;
				order.setIdOrder(DM->ATOrderMenu->FieldByName("id_order")->AsInteger);
				order.DeleteDBOrderMenu();
				DM->OpenDB();
		}
	}
	catch(...){
		MessageBox(NULL, L"Дані, пов'язанні з даною інформацією. Не можливо видалити!", L"Відмова!",  MB_OK |MB_ICONWARNING);
	}
}
//---------------------------------------------------------------------------



void __fastcall TFAdmin::ButtonDayReportClick(TObject *Sender)
{
	DM->DoSQL(DM->TSQL,"SELECT 	SUM(payment - (payment * discount/100)) AS DayPayment  \
	FROM ((OrderMenu INNER JOIN  Discounts ON id_discount = kod_discount)\
	INNER JOIN Personal ON id_personal = kod_personal)\
	INNER JOIN ListTable ON id_table = kod_table \
	WHERE date_open_order >= '"+DateToStr(Date())+" 00:00:00' and date_open_order <= '"+DateToStr(Date())+" 23:59:59'");
	ShowMessage("Дений заробіток - "+DM->TSQL->FieldByName("DayPayment")->AsString+" грн.");
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::buttonViewListOrderMenuClick(TObject *Sender)
{
    FEditOrderMenu->Show();
}
//---------------------------------------------------------------------------



void __fastcall TFAdmin::FormShow(TObject *Sender)
{
	DateFirst->Date = Date();
	DateSecond->Date = Date();
	TimeFirst->Time = StrToTime("0:00:00");
	TimeSecond->Time = StrToTime("23:59:59");
}
//---------------------------------------------------------------------------


void __fastcall TFAdmin::TimeFirstChange(TObject *Sender)
{
	DateFirst->Time = TimeFirst->Time;
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::DateFirstChange(TObject *Sender)
{
	DateFirst->Time = TimeFirst->Time;
	if (RBperiod->Checked) RBperiodClick(Sender);
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::DateSecondChange(TObject *Sender)
{
    DateSecond->Time = TimeSecond->Time;
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::TimeSecondChange(TObject *Sender)
{
	DateSecond->Time = TimeSecond->Time;
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::btnSaleIngredientClick(TObject *Sender)
{
	this->HidePanel(Sender);
	DM->DSReport->DataSet = DM->TReportIngredient;
	DM->OpenReport();
	PanelReport->Show();

}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::btnScoreDiscountClick(TObject *Sender)
{
	this->HidePanel(Sender);
	DM->DSReport->DataSet = DM->TReportDiscount;
	DM->OpenReport();
	PanelReport->Show();


}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::btnScorePersonalClick(TObject *Sender)
{
	this->HidePanel(Sender);
	DM->DSReport->DataSet = DM->TReportPersonal;
	DM->OpenReport();
	PanelReport->Show();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::btnShowOrderClick(TObject *Sender)
{
	this->HidePanel(Sender);
	PanelReport->Show();
	DM->DSReport->DataSet = DM->TReportOrder;
	DM->OpenReport();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::btnScoreFoodClick(TObject *Sender)
{
	this->HidePanel(Sender);
	DM->DSReport->DataSet = DM->TReportFood;
    DM->OpenReport();
	PanelReport->Show();
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::btnReportClick(TObject *Sender)
{
	String str = DM->DSReport->DataSet->Name;
	if (str == "TReportDiscount") { DM->frxScoreDiscount->ShowReport();}
	if (str == "TReportFood") { DM->frxScoreFood->ShowReport(); }
	if (str == "TReportIngredient"){ DM->frxSaleIngredient->ShowReport();}
	if (str == "TReportPersonal") { DM->frxScorePersonal->ShowReport();}
	if (str == "TReportOrder") {DM->frxShowOrder->ShowReport();}
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::RBallClick(TObject *Sender)
{
	DM->TReportDiscount->Filtered = false;
	DM->TReportFood->Filtered = false;
	DM->TReportPersonal->Filtered = false;
	DM->TReportIngredient->Filtered = false;
	DM->TReportOrder->Filtered = false;		
}
//---------------------------------------------------------------------------

void __fastcall TFAdmin::RBperiodClick(TObject *Sender)
{
	String str = DM->DSReport->DataSet->Name;
	String dt = "WHERE date_open_order >= '"+DateToStr(DateFirst->Date)+" "+TimeToStr(TimeFirst->Time)+"'  \
	and date_open_order <= '"+DateToStr(DateSecond->Date)+" "+TimeToStr(TimeSecond->Time)+"'";
	ShowMessage(dt);
	if (str == "TReportDiscount") {
	DM->DoSQL(DM->TReportDiscount,"SELECT id_discount,pib_client,count(id_order) AS CountBuyOrder,sum(payment - (payment*discount/100)) AS PaymentAll FROM Discounts INNER JOIN OrderMenu ON kod_discount = id_discount\
	"+dt+" 	GROUP BY id_discount,pib_client");
	}
	if (str == "TReportFood") {
	DM->DoSQL(DM->TReportFood,"SELECT name_food,count(counts) AS CountSale FROM (Food INNER JOIN ListOrderMenu ON kod_food = id_food) INNER JOIN OrderMenu ON id_order = kod_order \
	"+dt+" GROUP BY name_food ORDER BY CountSale desc");
	}
	if (str == "TReportIngredient");{
	DM->DoSQL(DM->TReportIngredient,"SELECT name_food,name_ingredient,price, sum(ListOrderMenu.counts * ListIngredientFood.counts) AsCountSaleIngredient,unit,sum(ListIngredientFood.price * ListOrderMenu.counts) AS SaleFood FROM ((OrderMenu INNER JOIN ListOrderMenu ON id_order = kod_order) INNER JOIN Food ON id_food = ListOrderMenu.kod_food )INNER JOIN ListIngredientFood ON ListIngredientFood.kod_food = id_food \
	"+dt+" GROUP BY name_food,name_ingredient,unit,price");
	}
	if (str == "TReportPersonal") {
	DM->DoSQL(DM->TReportPersonal,"SELECT pib_personal,count(id_order) AS CountOrder,sum(payment) AS Payment, sum(payment-(payment*discount/100)) AS PaymentDiscount FROM (Personal INNER JOIN OrderMenu ON id_personal = kod_personal) INNER JOIN Discounts ON kod_discount = id_discount \
	"+dt+" GROUP BY pib_personal ORDER BY CountOrder desc");
	}
	if (str == "TReportOrder") {
	DM->DoSQL(DM->TReportOrder,"SELECT id_order,date_open_order,pib_personal,pib_client,payment,discount,sum(payment-(payment*discount/100)) AS PaymentDiscount FROM ((OrderMenu INNER JOIN Personal ON id_personal = kod_personal) INNER JOIN Discounts ON id_discount = kod_discount) INNER JOIN ListTable ON id_table = kod_table \
	"+dt+" GROUP BY id_order,date_open_order,pib_personal,pib_client,payment,discount");
	}
}
//---------------------------------------------------------------------------

